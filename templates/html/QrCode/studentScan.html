<!DOCTYPE html>
<html>
<head>
    <title>Scan Attendance</title>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <style>
        #qr-reader {
            width: 300px;
            margin: 20px auto;
        }
        #msg {
            font-size: 18px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>

<body>

<h2 style="text-align:center;">Scan Event QR</h2>

<div id="qr-reader"></div>

<p id="msg"></p>

<script>
    // API URL
    const API_URL = "/api/validate/";

    // After QR Scan
    function onScanSuccess(decodedText, decodedResult) {
        console.log("Scanned Token:", decodedText);

        // Disable scanner to prevent multiple scans
        html5QrcodeScanner.clear();

        // Send token to backend
        submitAttendance(decodedText);
    }

    // Send token to Django backend
    function submitAttendance(token) {
        document.getElementById("msg").innerText = "Validating...";

        fetch(API_URL, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `token=${encodeURIComponent(token)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                document.getElementById("msg").style.color = "green";
                document.getElementById("msg").innerText = data.message;
            } else {
                document.getElementById("msg").style.color = "red";
                document.getElementById("msg").innerText = data.message;
            }
        })
        .catch(error => {
            document.getElementById("msg").style.color = "red";
            document.getElementById("msg").innerText = "Error validating attendance!";
            console.error("Error:", error);
        });
    }

    // Django CSRF Token Extractor
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // QR Scanner
    var html5QrcodeScanner = new Html5QrcodeScanner(
        "qr-reader",
        { fps: 10, qrbox: 250 },
        false
    );
    html5QrcodeScanner.render(onScanSuccess);
</script>

</body>
</html>
