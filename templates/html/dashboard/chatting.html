<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section Official Chat</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>
    <div id="chat-container">
        <header>
            <h2>Official Section Group Chat</h2>
        </header>
        <div id="messages-box">
            </div>
        <div id="typing-indicator">
            </div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="Type your message..." required>
            <button type="submit">Send</button>
        </form>
    </div>

    <script src="chat.js"></script>
</body>
</html>



<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f0f2f5;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
}

#chat-container {
    width: 90%;
    max-width: 600px;
    height: 80vh;
    background-color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
}

header {
    padding: 15px;
    background-color: #007bff;
    color: white;
    border-radius: 8px 8px 0 0;
}

#messages-box {
    flex-grow: 1;
    padding: 15px;
    overflow-y: auto;
    border-bottom: 1px solid #eee;
}

.message {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 18px;
    max-width: 80%;
    word-wrap: break-word;
}

.message.sent {
    background-color: #dcf8c6;
    margin-left: auto;
    text-align: right;
}

.message.received {
    background-color: #f1f0f0;
    margin-right: auto;
    text-align: left;
}

.sender-name {
    font-size: 0.8em;
    font-weight: bold;
    margin-bottom: 3px;
    display: block;
}

#message-form {
    display: flex;
    padding: 10px 15px;
    border-top: 1px solid #eee;
}

#message-input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 20px;
    margin-right: 10px;
}

#message-form button {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    cursor: pointer;
}

#typing-indicator {
    font-size: 0.9em;
    color: #666;
    padding: 5px 15px;
    height: 20px; /* Reserve space */
}
</style>



<script>
    document.addEventListener('DOMContentLoaded', () => {
    const chatSocket = new WebSocket(
        // IMPORTANT: Replace this with your actual Django Channels WebSocket URL
        'ws://127.0.0.1:8000/ws/chat/YOUR_GROUP_NAME/' 
    );

    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const messagesBox = document.getElementById('messages-box');
    const typingIndicator = document.getElementById('typing-indicator');

    let typingTimeout = null;
    const TYPING_DELAY = 2000; // Time in ms before typing status clears

    // --- Core Message Handling ---

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'chat_message') {
            displayMessage(data.sender_name, data.content, data.is_self);
        } else if (data.type === 'typing_status') {
            handleTypingStatus(data.username, data.is_typing);
        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
        // You might want to display a message to the user here
    };

    messageForm.onsubmit = function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message === '') return;

        // 1. Send the message via WebSocket
        chatSocket.send(JSON.stringify({
            'type': 'message',
            'content': message
        }));

        // 2. Clear input and hide typing status immediately
        messageInput.value = '';
        sendTypingStatus(false);
    };

    // Helper function to append a message to the DOM
    function displayMessage(senderName, content, isSelf) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', isSelf ? 'sent' : 'received');

        const nameSpan = document.createElement('span');
        nameSpan.classList.add('sender-name');
        nameSpan.textContent = senderName;

        messageDiv.appendChild(nameSpan);
        messageDiv.appendChild(document.createTextNode(content));
        
        messagesBox.appendChild(messageDiv);
        
        // Auto-scroll to the bottom of the chat box
        messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    // --- Typing Indicator Logic ---

    // Function to send typing status to the backend
    function sendTypingStatus(isTyping) {
        if (chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'type': 'typing',
                'is_typing': isTyping
            }));
        }
    }

    // Input event to monitor typing
    messageInput.addEventListener('input', () => {
        // Send true status only if the timer is not running (i.e., typing has started)
        if (!typingTimeout) {
            sendTypingStatus(true);
        }

        // Clear the previous timeout
        clearTimeout(typingTimeout);

        // Set a new timeout to send false status if the user stops typing
        typingTimeout = setTimeout(() => {
            sendTypingStatus(false);
            typingTimeout = null;
        }, TYPING_DELAY);
    });

    // Handle incoming typing status from others
    function handleTypingStatus(username, isTyping) {
        if (isTyping) {
            typingIndicator.textContent = `${username} is typing...`;
        } else {
            // Clear status if the user stops typing
            typingIndicator.textContent = '';
        }
    }
});
</script>